SET SQLPROMPT "";
SET SQLNUMBER OFF;


CONNECT SYSTEM/SYSTEM;

DROP USER E08 CASCADE;
CREATE USER E08 IDENTIFIED BY "E08";
GRANT CONNECT,RESOURCE TO E08;


CONNECT E08/E08;

CREATE TABLE MUNICIPIO
(
  ID        CHAR(4),
  NOMBRE    VARCHAR2(40) CONSTRAINT NN_NOMBRE NOT NULL,
  CODPOSTAL CHAR(5),
  PROVINCIA VARCHAR2(40),
  CONSTRAINT PK_MUNICIPIO PRIMARY KEY(ID)
);


CREATE TABLE VIVIENDA
(
  ID          CHAR(4),
  TIPO_VIA    VARCHAR2(10)  DEFAULT 'Calle',
  NOMBRE_VIA  VARCHAR2(50)  CONSTRAINT NN_NOMBRE_VIA NOT NULL,
  NUMERO      NUMBER(3)     CONSTRAINT NN_NUMERO NOT NULL,
  IDMUNICIPIO CHAR(4),
  CONSTRAINT PK_VIVIENDA  PRIMARY KEY(ID),
  CONSTRAINT FK_MUNICIPIO FOREIGN KEY(IDMUNICIPIO) 
    REFERENCES MUNICIPIO(ID)
);


CREATE TABLE PERSONA
(
  DNI        CHAR(9),
  NOMBRE     VARCHAR2(40),
  FECHA_NAC  DATE,
  SEXO       CHAR(1),
  IDVIVIENDA CHAR(4),
  CONSTRAINT PK_PERSONA PRIMARY KEY(DNI),
  CONSTRAINT FK_VIVENDA FOREIGN KEY(IDVIVIENDA) 
    REFERENCES VIVIENDA(ID),
  CONSTRAINT CK_SEXO CHECK (SEXO IN ('H', 'M'))
);


CREATE TABLE POSEE
(
  DNI        CHAR(9),
  IDVIVIENDA CHAR(4),
  CONSTRAINT PK_POSEE PRIMARY KEY(DNI, IDVIVIENDA),
  CONSTRAINT FK1_PERSONA  FOREIGN KEY(DNI) REFERENCES PERSONA(DNI),
  CONSTRAINT FK2_VIVIENDA FOREIGN KEY(IDVIVIENDA) 
    REFERENCES VIVIENDA(ID)
);


CREATE TABLE CABEZAFAMILIA
(
  DNI        CHAR(9),
  IDVIVIENDA CHAR(4),
  CONSTRAINT PK_CABEZA PRIMARY KEY(DNI),
  CONSTRAINT FK1_PER FOREIGN KEY(DNI) REFERENCES PERSONA(DNI),
  CONSTRAINT FK2_VIV FOREIGN KEY(IDVIVIENDA) REFERENCES VIVIENDA(ID),
  CONSTRAINT UQ_VIVIENDA  UNIQUE(IDVIVIENDA)
);
